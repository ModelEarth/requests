<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="UTF-8">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Arts Engine — X.ai Storyboard Generator</title>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script>
if (typeof param === 'undefined') { var param = {}; }
param.showsearch = "false";
</script>

<link type="text/css" rel="stylesheet" href="/localsite/css/base.css" id="/localsite/css/base.css" />
<link type="text/css" rel="stylesheet" href="/projects/css/issues.css" />
<link type="text/css" rel="stylesheet" href="css/app.css" />

<script type="text/javascript" src="/localsite/js/localsite.js?showheader=true"></script>
<script type="text/javascript" src="/projects/js/issues.js"></script>

<!--
  Config loader — reads template/config.yaml (or local config.yaml override).
  Populates #ae-title, #ae-subtitle, and window.AE_API_BASE before app.js runs.
  Inline fallback text in the HTML elements renders instantly if fetch is slow.
-->
<script>
(async function applyConfig() {
  function parseYaml(text) {
    const cfg = {};
    text.split('\n').forEach(line => {
      const t = line.trim();
      if (!t || t.startsWith('#')) return;
      const i = t.indexOf(':');
      if (i < 0) return;
      const key = t.slice(0, i).trim();
      let val = t.slice(i + 1).trim().replace(/#[^"']*$/, '').trim();
      val = val.replace(/^["']|["']$/g, '');
      cfg[key] = val;
    });
    return cfg;
  }

  let cfg = {};
  // Try local config.yaml first (agent override), then shared template
  for (const path of ['./config.yaml', '/requests/template/config.yaml']) {
    try {
      const r = await fetch(path);
      if (r.ok) { cfg = parseYaml(await r.text()); break; }
    } catch (_) {}
  }

  const title    = cfg.title    || 'Arts Engine';
  const subtitle = cfg.subtitle || 'Image & text generation via X.ai Grok API · Storyboard builder';
  const icon     = cfg.icon     || 'auto_awesome';

  document.title = title + ' — X.ai Storyboard Generator';

  const titleEl = document.getElementById('ae-title');
  if (titleEl) {
    titleEl.innerHTML =
      `<span class="material-icons" style="vertical-align:middle;margin-right:8px;color:#4a90e2">${icon}</span>${title}`;
  }

  const subtitleEl = document.getElementById('ae-subtitle');
  if (subtitleEl) subtitleEl.textContent = subtitle;

  // Make api_base available to app.js via global
  if (cfg.api_base) window.AE_API_BASE = cfg.api_base;
})();
</script>

</head>

<body>
<div class="content contentpadding" style="padding-top:30px; max-width:1600px">

  <!-- Page header — content populated from config.yaml, inline fallback shown instantly -->
  <div style="margin-bottom:24px">
    <h1 style="margin:0 0 6px 0; font-size:1.8rem" id="ae-title">
      <span class="material-icons" style="vertical-align:middle;margin-right:8px;color:#4a90e2">auto_awesome</span>Arts Engine
    </h1>
    <p style="margin:0; color:#888; font-size:0.95rem" id="ae-subtitle">
      Image &amp; text generation via X.ai Grok API · Storyboard builder
    </p>
    <div class="ae-backend-status" style="margin-top:8px">
      <span class="ae-backend-dot checking" id="backendDot"></span>
      <span id="backendLabel">Checking backend…</span>
      <span style="color:#bbb;margin:0 6px">·</span>
      <a href="javascript:void(0)" id="healthLink" style="font-size:0.78rem;color:#aaa"
         onclick="window.open((window.AE_API_BASE||'http://localhost:8082')+'/api/health')">health check</a>
    </div>
  </div>

  <!-- Main layout: 65% left / 35% right -->
  <div class="ae-container">

    <!-- =================================================================
         LEFT COLUMN — Prompt, Controls, Storyboard, Gallery
         ================================================================= -->
    <div class="ae-left">

      <!-- Prompt Input Panel -->
      <div class="ae-panel" id="promptPanel">
        <h3>Prompt</h3>
        <textarea id="promptInput"
          placeholder="Enter an image or text prompt… (Ctrl+Enter to generate)&#10;&#10;Example: A honey bee near wildflowers at golden hour, photorealistic"></textarea>

        <!-- CSV upload row -->
        <div class="ae-csv-row">
          <label class="ae-csv-btn" for="csvFileInput"
            title="Load prompts from a CSV with a 'Prompt' column. Drag &amp; drop also works.">
            <span class="material-icons" style="font-size:1rem">upload_file</span>
            Load CSV
          </label>
          <input type="file" id="csvFileInput" accept=".csv" style="display:none">
          <span class="ae-csv-name" id="csvFileName">No file loaded</span>
          <span style="flex:1"></span>
          <button class="ae-csv-btn" onclick="artsEngine && artsEngine.addScene()"
            title="Add current prompt as a new scene">
            <span class="material-icons" style="font-size:1rem">add</span>
            Add Scene
          </button>
          <button class="ae-csv-btn" id="clearPromptsBtn" title="Clear all scenes">
            <span class="material-icons" style="font-size:1rem">clear_all</span>
            Clear
          </button>
        </div>

        <!-- Loaded prompts list (populated by JS) -->
        <div id="promptList"></div>
      </div>

      <!-- Aspect Ratio Selector -->
      <div class="ae-panel">
        <h3>Aspect Ratio</h3>
        <div class="ae-ratio-group">

          <!-- Square 1:1 -->
          <button class="ae-ratio-btn" data-ratio="square">
            <div class="ratio-icon">
              <div class="ratio-box" style="width:32px;height:32px"></div>
            </div>
            <span class="ratio-label">Square 1:1</span>
          </button>

          <!-- Landscape Wide 16:9 -->
          <button class="ae-ratio-btn" data-ratio="landscape-wide">
            <div class="ratio-icon">
              <div class="ratio-box" style="width:48px;height:27px"></div>
            </div>
            <span class="ratio-label">Wide 16:9</span>
          </button>

          <!-- Landscape 4:3 -->
          <button class="ae-ratio-btn" data-ratio="landscape">
            <div class="ratio-icon">
              <div class="ratio-box" style="width:40px;height:30px"></div>
            </div>
            <span class="ratio-label">Landscape 4:3</span>
          </button>

          <!-- Portrait Tall 9:16 -->
          <button class="ae-ratio-btn" data-ratio="portrait-tall">
            <div class="ratio-icon">
              <div class="ratio-box" style="width:18px;height:32px"></div>
            </div>
            <span class="ratio-label">Tall 9:16</span>
          </button>

          <!-- Portrait 3:4 -->
          <button class="ae-ratio-btn" data-ratio="portrait">
            <div class="ratio-icon">
              <div class="ratio-box" style="width:24px;height:32px"></div>
            </div>
            <span class="ratio-label">Portrait 3:4</span>
          </button>

        </div>
      </div>

      <!-- Output Type + Generate -->
      <div class="ae-panel">
        <h3>Output</h3>
        <div style="display:flex;align-items:center;flex-wrap:wrap;gap:12px;justify-content:space-between">

          <div class="ae-type-row">
            <button class="ae-type-btn active" data-type="image">
              <span class="material-icons" style="font-size:0.95rem;vertical-align:middle">image</span>
              Image
            </button>
            <button class="ae-type-btn" data-type="text">
              <span class="material-icons" style="font-size:0.95rem;vertical-align:middle">text_fields</span>
              Text
            </button>
            <button class="ae-type-btn" data-type="video">
              <span class="material-icons" style="font-size:0.95rem;vertical-align:middle">videocam</span>
              Video
            </button>
          </div>

          <div class="ae-variations-row" style="margin-top:0;align-self:center">
            <label for="variationsInput">Variations:</label>
            <input type="number" id="variationsInput" min="1" max="4" value="2">
          </div>

          <!-- Model selector (hidden when outputType=image) -->
          <div id="modelRow" style="display:none">
            <select id="modelSelect" class="ae-model-select" title="Text model">
              <option value="grok-3-mini-beta">grok-3-mini-beta</option>
              <option value="grok-3">grok-3</option>
              <option value="grok-2-1212">grok-2-1212</option>
            </select>
          </div>

        </div>

        <div style="margin-top:14px">
          <button id="generateBtn">
            <span class="material-icons">auto_awesome</span>
            Generate
          </button>
        </div>

        <div id="statusBar" style="display:none"></div>
      </div>

      <!-- Storyboard Flowchart Panel -->
      <div class="ae-panel">
        <h3>
          <span class="material-icons" style="font-size:1rem;vertical-align:middle;margin-right:4px">account_tree</span>
          Storyboard Flow
        </h3>
        <p style="margin:0 0 12px 0;font-size:0.85rem;color:#888">
          ComfyUI-style scene graph — load a CSV or add scenes above
        </p>
        <div id="storyboardContainer"></div>
      </div>

      <!-- Gallery Panel (revealed after first generation) -->
      <div class="ae-panel" id="galleryPanel">
        <h3 style="display:flex;align-items:center;justify-content:space-between">
          <span>
            <span class="material-icons" style="font-size:1rem;vertical-align:middle;margin-right:4px">photo_library</span>
            Generated Output
          </span>
          <button id="rawToggleBtn" title="View raw API response"
            onclick="artsEngine && artsEngine.toggleRaw()"
            style="background:none;border:none;cursor:pointer;padding:2px 4px;color:#aaa;line-height:1">
            <span class="material-icons" style="font-size:1.1rem;vertical-align:middle">settings</span>
          </button>
        </h3>
        <div id="gallery" class="ae-gallery"></div>
        <pre id="rawPanel" style="display:none;margin-top:14px;padding:12px;background:#f6f8fa;
          border-radius:8px;font-size:0.75rem;overflow:auto;max-height:300px;white-space:pre-wrap;
          word-break:break-all;color:#333"></pre>
      </div>

    </div><!-- /ae-left -->

    <!-- =================================================================
         RIGHT COLUMN — GitHub Token Widget + Settings
         ================================================================= -->
    <div class="ae-right">

      <!-- GitHub Token Widget (projects/js/issues.js) -->
      <div class="ae-panel">
        <h3>
          <span class="material-icons" style="font-size:1rem;vertical-align:middle;margin-right:4px">hub</span>
          GitHub Output
        </h3>
        <p style="margin:0 0 10px 0;font-size:0.83rem;color:#888">
          Enter your GitHub token to save generated images to your repo
        </p>
        <!--
          Arts Engine / GitHub Token Widget
          Token saved in localStorage as 'github_token'
          Widget title can be set via JS config; showProject:false for minimal view
        -->
        <div id="issues-root"></div>

        <!-- Save button revealed after generation -->
        <button id="saveGithubBtn" style="width:100%;margin-top:10px;
          padding:10px;background:#2da44e;color:#fff;border:none;border-radius:8px;
          font-size:0.9rem;font-weight:600;cursor:pointer;align-items:center;
          justify-content:center;gap:6px">
          <span class="material-icons" style="font-size:1rem">upload</span>
          Save to GitHub
        </button>
      </div>

      <!-- Settings Panel -->
      <div class="ae-panel">
        <h3>
          <span class="material-icons" style="font-size:1rem;vertical-align:middle;margin-right:4px">settings</span>
          Settings
        </h3>
        <div class="ae-settings-row">
          <label>
            Backend URL
            <input type="text" id="apiBaseInput" value="http://localhost:8082"
              style="padding:6px 10px;border:1.5px solid #ddd;border-radius:8px;
                     font-size:0.85rem;width:100%;box-sizing:border-box">
          </label>
          <div style="font-size:0.8rem;color:#aaa;line-height:1.6">
            <strong>Start Rust backend:</strong><br>
            <code style="background:rgba(0,0,0,0.06);padding:2px 6px;border-radius:4px;font-size:0.78rem">
              cd rust-api &amp;&amp; cargo run
            </code>
          </div>
          <div style="font-size:0.8rem;color:#aaa;line-height:1.6">
            Add <code style="background:rgba(0,0,0,0.06);padding:2px 4px;border-radius:4px">XAI_API_KEY</code>
            to <code style="background:rgba(0,0,0,0.06);padding:2px 4px;border-radius:4px">docker/.env</code>
          </div>
        </div>
      </div>

      <!-- Sample CSV & Reference Links -->
      <div class="ae-panel">
        <h3>
          <span class="material-icons" style="font-size:1rem;vertical-align:middle;margin-right:4px">table_chart</span>
          Sample Prompts
        </h3>
        <p style="margin:0 0 10px 0;font-size:0.83rem;color:#888">
          CSV needs a <strong>Prompt</strong> column. Optional:
          <code>Industry</code>, <code>aspect_ratio</code>, <code>style</code>, <code>scene</code>, <code>Naics</code>
        </p>
        <a href="prompts.csv" download class="ae-csv-btn" style="display:inline-flex;text-decoration:none">
          <span class="material-icons" style="font-size:1rem">download</span>
          Download sample CSV
        </a>
      </div>

      <!-- API Reference -->
      <div class="ae-panel" style="font-size:0.83rem">
        <h3>
          <span class="material-icons" style="font-size:1rem;vertical-align:middle;margin-right:4px">info</span>
          API Reference
        </h3>
        <ul style="margin:0;padding-left:16px;color:#888;line-height:1.9">
          <li><a href="https://docs.x.ai/docs" target="_blank">X.ai API Docs</a></li>
          <li><a href="https://docs.rs/api_xai/latest/api_xai/" target="_blank">api_xai Rust crate</a></li>
          <li><a href="https://github.com/ModelEarth/requests" target="_blank">requests repo</a></li>
        </ul>
      </div>

    </div><!-- /ae-right -->

  </div><!-- /ae-container -->


  <script type="text/javascript" src="../../localsite/js/embed.js?showindex=1&showheader=true"></script>
  <div id="listwidget"></div>

</div><!-- /content -->

<!-- Lightbox overlay (full-screen image view, Escape or click outside to close) -->
<div class="ae-lightbox" id="aeLightbox">
  <span class="ae-lightbox-close material-icons"
    onclick="artsEngine && artsEngine.closeLightbox()">close</span>
  <img id="aeLightboxImg" src="" alt="Generated image">
</div>

<script type="text/javascript" src="js/app.js"></script>

<script>
// Sync backend URL input with config.yaml api_base once loaded
document.addEventListener('DOMContentLoaded', function () {
  // Small delay to let the async config fetch settle
  setTimeout(function () {
    const input = document.getElementById('apiBaseInput');
    if (input && window.AE_API_BASE) input.value = window.AE_API_BASE;
  }, 300);

  // Show model selector only for text output type
  function syncModelRow() {
    const type = document.querySelector('.ae-type-btn.active')?.dataset?.type;
    const row = document.getElementById('modelRow');
    if (row) row.style.display = type === 'text' ? '' : 'none';
  }
  document.querySelectorAll('.ae-type-btn').forEach(btn =>
    btn.addEventListener('click', syncModelRow));
  syncModelRow();
});
</script>

</body>
</html>
